name: OemPorts10T

on:
  # Pemicu diubah ke repository_dispatch untuk menerima request dari API eksternal (Telegram Bot)
  repository_dispatch:
    types: [telegram_request] # Tipe event yang akan dipicu oleh Bot Telegram Anda

env:
  NDK_VERSION: '28.2.13676358'
  CMDLINE_TOOLS_VERSION: '12266719'

jobs:
  setup-environment:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      ndk-home: ${{ steps.setup-ndk.outputs.ndk-home }}
      android-sdk-version: ${{ env.ANDROID_SDK_VERSION }}
      build-tools-version: ${{ env.BUILD_TOOLS_VERSION }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      # Langkah 1: Validasi dan Set Environment Variables dari client_payload
      - name: Validate and Set Inputs
        run: |
          # Ambil data dari payload yang dikirim oleh Bot Telegram
          ANDROID_VERSION="${{ github.event.client_payload.android_version }}"
          FRAMEWORK_URL="${{ github.event.client_payload.framework_url }}"
          USERNAME="${{ github.event.client_payload.username }}"
          if [[ -z "$USERNAME" ]]; then
              USERNAME="Anonymous/Unknown"
          fi
          
          echo "Processing Request: Android=$ANDROID_VERSION, URL=$FRAMEWORK_URL, User=$USERNAME"
          
          # Validasi Android version
          if [[ ! "$ANDROID_VERSION" =~ ^(12|13|14|15|16)$ ]]; then
            echo "âŒ Error: Invalid Android version ($ANDROID_VERSION). Must be 12, 13, 14, 15, or 16"
            exit 1
          fi
          
          # Validasi Framework URL
          if [[ -z "$FRAMEWORK_URL" ]]; then
            echo "âŒ Error: Framework URL cannot be empty"
            exit 1
          fi
          
          # Set Environment Variables agar dapat diakses di langkah-langkah selanjutnya
          echo "ANDROID_VERSION_INPUT=$ANDROID_VERSION" >> $GITHUB_ENV
          echo "FRAMEWORK_URL_INPUT=$FRAMEWORK_URL" >> $GITHUB_ENV
          echo "REQUEST_USERNAME=$USERNAME" >> $GITHUB_ENV
          
          echo "âœ… Input validation passed for: $ANDROID_VERSION, $FRAMEWORK_URL"

      # Langkah 2: Setup Android Version
      - name: Setup Android Version
        run: |
          case "${{ env.ANDROID_VERSION_INPUT }}" in
            12)
              echo "ANDROID_SDK_VERSION=32" >> $GITHUB_ENV
              echo "BUILD_TOOLS_VERSION=32.0.0" >> $GITHUB_ENV
              ;;
            13)
              echo "ANDROID_SDK_VERSION=33" >> $GITHUB_ENV
              echo "BUILD_TOOLS_VERSION=33.0.0" >> $GITHUB_ENV
              ;;
            14)
              echo "ANDROID_SDK_VERSION=34" >> $GITHUB_ENV
              echo "BUILD_TOOLS_VERSION=34.0.0" >> $GITHUB_ENV
              ;;
            15)
              echo "ANDROID_SDK_VERSION=35" >> $GITHUB_ENV
              echo "BUILD_TOOLS_VERSION=35.0.0" >> $GITHUB_ENV
              ;;
            16)
              echo "ANDROID_SDK_VERSION=36" >> $GITHUB_ENV
              echo "BUILD_TOOLS_VERSION=36.0.0" >> $GITHUB_ENV
              ;;
          esac

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3
        with:
          log-accepted-android-sdk-licenses: false
          cmdline-tools-version: ${{ env.CMDLINE_TOOLS_VERSION }}
          packages: 'platforms;android-${{ env.ANDROID_SDK_VERSION }} build-tools;${{ env.BUILD_TOOLS_VERSION }} platform-tools'

      - name: Install Download Tools
        run: |
          echo "ğŸ“¥ Installing download tools..."
          sudo apt-get install -y \
            wget \
            curl \
            python3 \
            python3-pip \
            aria2 \
            unzip
          
          pip3 install gdown
          sudo apt-get install -y megatools
          sudo apt-get install -y lftp
          
          echo "âœ… Download tools installed"

      - name: Install NDK
        id: setup-ndk
        run: |
          echo "ğŸ“¥ Installing NDK version ${{ env.NDK_VERSION }}..."
          echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager \
            --channel=0 \
            --install "ndk;${{ env.NDK_VERSION }}"
          
          NDK_PATH="$ANDROID_HOME/ndk/${{ env.NDK_VERSION }}"
          
          echo "NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=$NDK_PATH" >> $GITHUB_ENV
          echo "ndk-home=$NDK_PATH" >> $GITHUB_OUTPUT
          
          echo "$ANDROID_HOME/platform-tools" >> $GITHUB_PATH
          echo "$ANDROID_HOME/build-tools/${{ env.BUILD_TOOLS_VERSION }}" >> $GITHUB_PATH
          
          echo "âœ… NDK installed at: $NDK_PATH"

      # --- PERBAIKAN DITERAPKAN DI SINI ---
      - name: Verify NDK Installation
        run: |
          echo "ğŸ” Verifying NDK installation..."
          # Menggunakan $NDK_HOME yang telah diekspor ke GITHUB_ENV
          if [ ! -d "$NDK_HOME" ]; then
            echo "âŒ Error: NDK directory not found at $NDK_HOME"
            exit 1
          fi
          
          # Menggunakan $NDK_HOME yang telah diekspor
          ls -la "$NDK_HOME" || exit 1 
          echo "âœ… NDK verification successful"

      - name: Clone Source
        run: |
          git clone ${{ secrets.OEM_URL }} OEM

      # Langkah 3: Download Framework
      - name: Download Framework
        id: download-framework
        run: |
          echo "ğŸ“¥ Downloading framework.jar..."
          cd ${{ github.workspace }}/OEM/framework_patcher
          
          URL="${{ env.FRAMEWORK_URL_INPUT }}"
          echo "Download URL: $URL"
          
          detect_url_type() {
            if [[ "$1" == *"drive.google.com"* ]] || [[ "$1" == *"docs.google.com"* ]]; then
              echo "google_drive"
            elif [[ "$1" == *"mega.nz"* ]] || [[ "$1" == *"mega.co.nz"* ]]; then
              echo "mega"
            elif [[ "$1" == *"mediafire.com"* ]]; then
              echo "mediafire"
            elif [[ "$1" == *"dropbox.com"* ]]; then
              echo "dropbox"
            elif [[ "$1" == *"github.com"* ]] || [[ "$1" == *"raw.githubusercontent.com"* ]]; then
              echo "direct"
            elif [[ "$1" == *"sourceforge.net"* ]]; then
              echo "sourceforge"
            else
              echo "direct"
            fi
          }
          
          URL_TYPE=$(detect_url_type "$URL")
          echo "Detected URL type: $URL_TYPE"
          
          download_with_fallback() {
            local url=$1
            local output=$2
            
            echo "ğŸ”§ Attempting to download using method: $URL_TYPE"
            
            case $URL_TYPE in
              "google_drive")
                if [[ $url =~ /d/([^/]+) ]]; then
                  FILE_ID="${BASH_REMATCH[1]}"
                elif [[ $url =~ id=([^&]+) ]]; then
                  FILE_ID="${BASH_REMATCH[1]}"
                else
                  FILE_ID=$(echo "$url" | grep -o '[^/]*$')
                fi
                
                if command -v gdown &> /dev/null; then
                  if gdown "https://drive.google.com/uc?id=$FILE_ID" -O "$output"; then
                    echo "âœ… Google Drive download successful with gdown"
                    return 0
                  fi
                fi
                
                echo "ğŸ”„ Trying curl method for Google Drive..."
                CONFIRM=$(wget --quiet --save-cookies /tmp/cookies.txt --keep-session-cookies --no-check-certificate "https://docs.google.com/uc?export=download&id=$FILE_ID" -O- | sed -rn 's/.*confirm=([0-9A-Za-z_]+).*/\1/p')
                if wget --load-cookies /tmp/cookies.txt "https://docs.google.com/uc?export=download&confirm=$CONFIRM&id=$FILE_ID" -O "$output"; then
                  echo "âœ… Google Drive download successful with curl"
                  return 0
                fi
                ;;
              "mega")
                if command -v megadl &> /dev/null; then
                  if megadl "$url" --path "$output"; then
                    echo "âœ… MEGA download successful"
                    return 0
                  fi
                fi
                ;;
              "mediafire")
                DIRECT_URL=$(curl -s "$url" | grep -o 'https://download[^"]*' | head -1)
                if [ -n "$DIRECT_URL" ]; then
                  if wget "$DIRECT_URL" -O "$output"; then
                    echo "âœ… MediaFire download successful"
                    return 0
                  fi
                fi
                ;;
              "dropbox")
                if [[ $url == *"?dl=0"* ]]; then
                  url="${url/?dl=0/?dl=1}"
                elif [[ $url != *"?dl=1"* ]]; then
                  url="${url}?dl=1"
                fi
                ;;
              "sourceforge")
                PROJECT=$(echo "$url" | grep -o 'projects/[^/]*' | cut -d'/' -f2)
                FILE=$(echo "$url" | grep -o 'files/[^/]*' | cut -d'/' -f2)
                if [ -n "$PROJECT" ] && [ -n "$FILE" ]; then
                  url="https://downloads.sourceforge.net/project/$PROJECT/$FILE"
                fi
                ;;
            esac
            
            echo "ğŸ”„ Using universal download methods..."
            if command -v aria2c &> /dev/null; then
              if aria2c --check-certificate=false --max-tries=3 --timeout=300 --max-connection-per-server=4 "$url" -o "$output"; then
                echo "âœ… Download successful with aria2"
                return 0
              fi
            fi
            
            if wget --progress=dot:giga --timeout=300 --tries=3 "$url" -O "$output"; then
              echo "âœ… Download successful with wget"
              return 0
            fi
            
            if curl -L --connect-timeout 300 --retry 3 --progress-bar "$url" -o "$output"; then
              echo "âœ… Download successful with curl"
              return 0
            fi
            
            return 1
          }
          
          # Perform download
          if ! download_with_fallback "$URL" "framework.jar"; then
            echo "âŒ Error: All download methods failed for URL: $URL"
            exit 1
          fi
          
          # Verify downloaded file
          if [ ! -f "framework.jar" ]; then
            echo "âŒ Error: framework.jar was not downloaded"
            exit 1
          fi
          
          FILESIZE=$(stat -c%s "framework.jar" 2>/dev/null || stat -f%z "framework.jar")
          if [ "$FILESIZE" -lt 1000 ]; then
            echo "âŒ Error: framework.jar seems too small (only $FILESIZE bytes), download might have failed"
            exit 1
          fi
          
          echo "âœ… Framework download successful from $URL_TYPE"

      - name: Apply Patch
        run: |
          echo "ğŸ”§ Applying framework patch..."
          cd ${{ github.workspace }}/OEM/framework_patcher
          
          if [ -f "patchframework.sh" ]; then
            chmod +x patchframework.sh
          else
            echo "âŒ Error: patchframework.sh not found"
            exit 1
          fi
          
          if ! ./patchframework.sh; then
            echo "âŒ Error: patchframework.sh failed with exit code $?"
            exit 1
          fi
          
          echo "âœ… Patch applied successfully"

      - name: Verify Patched Framework
        run: |
          echo "ğŸ” Verifying patched framework..."
          FRAMEWORK_PATH="${{ github.workspace }}/OEM/framework_patcher/framework.jar"
          
          if [ ! -f "$FRAMEWORK_PATH" ]; then
            echo "âŒ Error: framework.jar not found after patching at $FRAMEWORK_PATH"
            exit 1
          fi
          
          FILESIZE=$(stat -c%s "$FRAMEWORK_PATH" 2>/dev/null || stat -f%z "$FRAMEWORK_PATH")
          if [ "$FILESIZE" -lt 1000 ]; then
            echo "âŒ Error: Patched framework.jar seems too small, patching might have failed"
            exit 1
          fi
          
          echo "âœ… Patched framework verification successful"

      # Langkah 5: Upload ke Telegram
      - name: Upload to Telegram
        run: |
          curl -F document=@"${{ github.workspace }}/OEM/framework_patcher/framework.jar" "https://api.telegram.org/bot${{ secrets.TELEGRAM_TOKEN }}/sendDocument" \
            -F chat_id="${{ secrets.TELEGRAM_TO }}" \
            -F "disable_web_page_preview=true" \
            -F "parse_mode=html" \
            -F caption=$'ğŸ‰ <b>Framework Patching Completed Successfully!</b>\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“‹ <b>Build Information</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ‘¤ <b>Request From:</b> ${{ env.REQUEST_USERNAME }}\nğŸ“± <b>Android Version:</b> ${{ env.ANDROID_VERSION_INPUT }}\nğŸ”§ <b>SDK Version:</b> ${{ env.ANDROID_SDK_VERSION }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’¡ <b>Note</b>\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nâš ï¸ File ini adalah <code>framework.jar</code> yang telah dipatch untuk keperluan OEM Porting Android.\nğŸ“¦ <i>File siap digunakan untuk modifikasi dan custom ROM development.</i>'

      # Langkah 6: Success Message
      - name: Success Message
        if: success()
        run: |
          echo "ğŸ‰ Framework patching completed successfully!"
          echo "ğŸ“± Android Version: ${{ env.ANDROID_VERSION_INPUT }}"
          echo "ğŸ”§ SDK Version: ${{ env.ANDROID_SDK_VERSION }}"
          echo "ğŸ“¤ Uploaded to Telegram successfully!"
